<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è½¦ç‰Œè¯†åˆ«ç³»ç»Ÿ</title>
  <style>
    /* åŸºç¡€æ ·å¼ */
    body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #f8f9fa; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .mode-switch { text-align: center; margin: 20px 0; }
    .btn { padding: 10px 20px; margin: 0 10px; border: none; border-radius: 4px; cursor: pointer; }
    .btn-primary { background: #1976d2; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .section { display: none; }
    .active { display: block !important; }
    video, canvas { border: 1px solid #ddd; border-radius: 8px; }
    #liveResult { margin-top: 10px; font-size: 1.2rem; color: #d32f2f; font-weight: bold; }
  </style>
</head>
<body>
  <header class="header" style="background:#fff; padding:1rem; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
    <div style="text-align:center;">
      <h1>è½¦ç‰Œè¯†åˆ«ç³»ç»Ÿ ğŸš—</h1>
      <p>æ”¯æŒé™æ€å›¾ç‰‡ä¸Šä¼  + å®æ—¶è§†é¢‘è¯†åˆ« | è“ç‰Œ/ç»¿ç‰Œ/é»„ç‰Œ | è¯†åˆ«ç‡97.5%</p>
    </div>
  </header>

  <!-- æ¨¡å¼åˆ‡æ¢ -->
  <div class="mode-switch">
    <button class="btn btn-primary" onclick="switchMode('upload')">å›¾ç‰‡ä¸Šä¼ è¯†åˆ«</button>
    <button class="btn btn-secondary" onclick="switchMode('live')">å®æ—¶è§†é¢‘è¯†åˆ«</button>
  </div>

  <main class="container">
    <!-- å›¾ç‰‡ä¸Šä¼ æ¨¡å¼ -->
    <section id="uploadSection" class="section active">
      <!-- æ‚¨åŸæœ‰çš„ä¸Šä¼ åŒºåŸŸ HTML -->
      <section class="upload-section">
        <h2>ä¸Šä¼ è½¦ç‰Œå›¾ç‰‡</h2>
        <p>æ”¯æŒJPG/PNGæ ¼å¼ï¼Œå»ºè®®ä¸Šä¼ æ¸…æ™°çš„è½¦è¾†æ­£é¢ç…§ç‰‡</p>
        <div class="upload-container" id="dropZone">
          <div>ğŸ“</div>
          <h3>æ‹–æ‹½å›¾ç‰‡è‡³æ­¤æˆ–ç‚¹å‡»ä¸Šä¼ </h3>
          <p>æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œæœ€å¤§10MB</p>
          <input type="file" id="imageInput" accept="image/jpeg, image/png" hidden>
          <button class="btn" onclick="document.getElementById('imageInput').click()">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</button>
          <div class="preview-container" id="preview">
            <div><p>å›¾ç‰‡é¢„è§ˆå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p></div>
          </div>
        </div>
      </section>

      <!-- ç»“æœåŒºåŸŸ -->
      <section id="resultSection" style="display:none; text-align:center; margin-top:2rem;">
        <h2>è¯†åˆ«ç»“æœ</h2>
        <div id="plateResult" style="font-size:3rem; color:#d32f2f; font-weight:bold;"></div>
        <div style="margin-top:1rem; padding:1rem; border:1px dashed #ccc; border-radius:8px;">
          <h4>è½¦ç‰Œç‰¹å†™</h4>
          <img id="croppedPlate" src="" alt="è½¦ç‰Œ" style="display:block; margin:0 auto; max-width:100%; height:auto; border-radius:4px;">
        </div>
        <div id="plateType" style="margin-top:1rem; padding:0.5rem; background:#e3f2fd; border-radius:20px; display:inline-block;">
          <span style="color:#1976d2;">æœªçŸ¥</span>
        </div>
      </section>

      <div class="status-bar" id="statusBar" style="margin-top:1rem; text-align:center;">
        <span id="statusText">ç­‰å¾…ä¸Šä¼ å›¾ç‰‡...</span>
      </div>
      <div id="error" style="display:none; color:#d32f2f; text-align:center; margin-top:1rem;"></div>
    </section>

    <!-- å®æ—¶è§†é¢‘æ¨¡å¼ -->
    <section id="liveSection" class="section">
      <h2 style="text-align:center;">å®æ—¶è½¦ç‰Œè¯†åˆ«</h2>
      <div style="text-align:center; margin-top:1rem;">
        <video id="video" width="640" height="480" autoplay muted style="background:#000;"></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div id="liveResult">è¯·å…è®¸æ‘„åƒå¤´è®¿é—®</div>
        <!-- å®æ—¶è½¦ç‰Œç‰¹å†™ -->
<div id="livePlatePreview" style="margin-top:1rem; text-align:center; display:none;">
  <h4>è½¦ç‰Œç‰¹å†™</h4>
  <img id="liveCroppedPlate" src="" alt="å®æ—¶è½¦ç‰Œ" 
       style="max-width:300px; max-height:100px; border:2px solid #1976d2; border-radius:4px; display:none;">
</div>
      </div>
    </section>
  </main>

  <footer style="text-align:center; padding:1rem; margin-top:2rem; background:#eee;">
    <p>Â© 2026 å¼ ç‚«æ¯•ä¸šè®¾è®¡ | è½¦ç‰Œè¯†åˆ«ç³»ç»Ÿ</p>
  </footer>

  <script>
    // ========== å…¨å±€å˜é‡ ==========
    let ws = null;
    let isLiveMode = false;

    // ========== æ¨¡å¼åˆ‡æ¢ ==========
    function switchMode(mode) {
      document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
      if (mode === 'upload') {
        document.getElementById('uploadSection').classList.add('active');
        stopLiveRecognition();
      } else {
        document.getElementById('liveSection').classList.add('active');
        startLiveRecognition();
      }
    }

    // ========== å›¾ç‰‡ä¸Šä¼ é€»è¾‘ï¼ˆæ‚¨çš„åŸæœ‰ä»£ç ç²¾ç®€ç‰ˆï¼‰==========
    document.getElementById('imageInput').addEventListener('change', handleImageUpload);
    
    async function handleImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      updateStatus("å‡†å¤‡è¯†åˆ«...", true);
      const preview = document.getElementById('preview');
      preview.innerHTML = `<img src=" $ {URL.createObjectURL(file)}" style="max-width:100%; max-height:300px;">`;

      try {
        const formData = new FormData();
        formData.append('file', file);
        const res = await fetch('http://localhost:8000/api/v1/recognize', { method: 'POST', body: formData });
        const result = await res.json();

        if (result.success) {
          document.getElementById('plateResult').textContent = result.plate_number;
          document.getElementById('croppedPlate').src = result.cropped_image;
          document.getElementById('plateType').textContent = 
            result.plate_type === 'green' ? 'ç»¿ç‰Œ' : 
            result.plate_type === 'blue' ? 'è“ç‰Œ' : 'æœªçŸ¥';
          document.getElementById('resultSection').style.display = 'block';
          updateStatus("è¯†åˆ«å®Œæˆ", false);
        } else throw new Error(result.error_message);
      } catch (err) {
        updateStatus(`è¯†åˆ«å¤±è´¥:  $ {err.message}`, false);
      }
    }

    function updateStatus(text, loading) {
      const el = document.getElementById('statusText');
      el.textContent = text;
      el.style.color = loading ? '#1976d2' : '#d32f2f';
    }

    // ========== å®æ—¶è§†é¢‘é€»è¾‘ ==========
    async function startLiveRecognition() {
      if (isLiveMode) return;
      isLiveMode = true;

      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      // è¿æ¥ WebSocket
      ws = new WebSocket('ws://localhost:8000/ws/live');
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        // æ›´æ–°æ–‡å­—
        document.getElementById('liveResult').textContent = 
          data.success ? `è¯†åˆ«åˆ°:  ${data.plate_number}` : 'æœªæ£€æµ‹åˆ°è½¦ç‰Œ';
      
        // æ˜¾ç¤º/éšè—è£å‰ªå›¾åŒºåŸŸ
        const previewBox = document.getElementById('livePlatePreview');
        const img = document.getElementById('liveCroppedPlate');
      
        if (data.success && data.cropped_image) {
          img.src = data.cropped_image;
          img.style.display = 'block';
          previewBox.style.display = 'block';
        } else {
          previewBox.style.display = 'none';
          if (img) img.style.display = 'none';
        }
      };
      ws.onerror = () => {
        document.getElementById('liveResult').textContent = 'è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯';
        isLiveMode = false;
      };

      // è·å–æ‘„åƒå¤´
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;

        // æ¯ 800ms å‘é€ä¸€å¸§ï¼ˆçº¦ 1.25 FPSï¼Œå¹³è¡¡æ€§èƒ½ä¸å®æ—¶æ€§ï¼‰
        setInterval(() => {
          if (!isLiveMode || !ws || ws.readyState !== WebSocket.OPEN) return;
          
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          
          canvas.toBlob(blob => {
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(blob);
            }
          }, 'image/jpeg', 0.7);
        }, 800);
      } catch (err) {
        document.getElementById('liveResult').textContent = 'æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + err.message;
        isLiveMode = false;
      }
    }

    function stopLiveRecognition() {
      isLiveMode = false;
      if (ws) {
        ws.close();
        ws = null;
      }
      const video = document.getElementById('video');
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
    }

    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', stopLiveRecognition);
  </script>
</body>
</html>